<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lino Galiana">

<title>Introduction aux méthodes quantitatives avec  - Produire des cartes avec </title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="Introduction aux méthodes quantitatives avec  - Produire des cartes avec ">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://rgeo.linogaliana.fr/cards/version-light/baby.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Introduction aux méthodes quantitatives avec <i class="fa-brands fa-r-project" aria-label="r-project"></i></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../exercises/r-base.html" rel="" target="">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../exercises/r-wrangling.html" rel="" target="">
 <span class="menu-text">Manipulation</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/linogaliana/r-geographie" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#données" id="toc-données" class="nav-link active" data-scroll-target="#données"><span class="header-section-number">1</span> Données</a>
  <ul class="collapse">
  <li><a href="#comptages" id="toc-comptages" class="nav-link" data-scroll-target="#comptages"><span class="header-section-number">1.1</span> Comptages</a></li>
  <li><a href="#localisation-des-compteurs" id="toc-localisation-des-compteurs" class="nav-link" data-scroll-target="#localisation-des-compteurs"><span class="header-section-number">1.2</span> Localisation des compteurs</a></li>
  <li><a href="#fonds-de-carte-contextuels" id="toc-fonds-de-carte-contextuels" class="nav-link" data-scroll-target="#fonds-de-carte-contextuels"><span class="header-section-number">1.3</span> Fonds de carte contextuels</a></li>
  </ul></li>
  <li><a href="#une-première-carte-avec-ggplot" id="toc-une-première-carte-avec-ggplot" class="nav-link" data-scroll-target="#une-première-carte-avec-ggplot"><span class="header-section-number">2</span> Une première carte avec <code>ggplot</code></a></li>
  <li><a href="#heatmap" id="toc-heatmap" class="nav-link" data-scroll-target="#heatmap"><span class="header-section-number">3</span> Heatmap</a></li>
  <li><a href="#carte-de-fréquentation-des-stations" id="toc-carte-de-fréquentation-des-stations" class="nav-link" data-scroll-target="#carte-de-fréquentation-des-stations"><span class="header-section-number">4</span> Carte de fréquentation des stations</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Produire des cartes avec <i class="fa-brands fa-r-project" aria-label="r-project"></i></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lino Galiana </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="badge">
<p><a href="https://datalab.sspcloud.fr/launcher/ide/rstudio?autoLaunch=true&amp;init.personalInit=«https%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fr-geographie%2Fmain%2Fsspcloud%2Finit.sh»&amp;networking.user.enabled=true&amp;onyxia.friendlyName=«rstudio-cours-ENS»" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/Tester%20via%20SSP%20cloud%20-%20SSPCloud?logo=R&amp;labelColor=black&amp;color=%231965b8" alt="Onyxia"></a><br></p>
</div>
<details>
<summary>
Dérouler les <em>slides</em> ci-dessous ou <a href="../slides/ggplot.html">cliquer ici</a> pour afficher les slides en plein écran.
</summary>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><iframe class="sourceCode yaml code-with-copy" src="/slides/ggplot.html"></iframe></div>
</details>
<p>Dans ce TP, nous allons apprendre à créer des cartes avec <i class="fa-brands fa-r-project" aria-label="r-project"></i>. A mesure que <i class="fa-brands fa-r-project" aria-label="r-project"></i> devient incontournable auprès des personnes manipulant des données spatiales, les solutions pour produire des cartes de qualité deviennent de plus en plus nombreuses. <i class="fa-brands fa-r-project" aria-label="r-project"></i> a de moins en moins à envier aux logiciels spécialisés comme QGIS.</p>
<p>Si vous êtes intéressés par <code>Python</code> <i class="fa-brands fa-python" aria-label="python"></i>, une version très proche de ce TP est disponible dans <a href="https://pythonds.linogaliana.fr/content/visualisation/maps.html">mon cours de l’ENSAE</a>.</p>
<p>La pratique de la cartographie se fera, dans la continuité du chapitre sur les graphiques, en répliquant des cartes qu’on peut trouver sur la page de l’<em>open-data</em> de la ville de Paris <a href="https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/dataviz/?disjunctive.id_compteur&amp;disjunctive.nom_compteur&amp;disjunctive.id&amp;disjunctive.name">ici</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Produire de belles cartes demande du temps mais aussi du bon sens. Comme toute représentation graphique, il est important de réfléchir au message à faire passer et aux moyens appropriés. La sémiologie cartographique, une discipline scientifique qui s’intéresse aux messages transmis par les cartes, propose certaines règles pour éviter de transmettre des messages faussés, volontairement ou involontairement.</p>
<p>Certaines peuvent être retrouvées à travers des conseils pratiques dans ce <a href="https://www.insee.fr/fr/statistiques/3640429">guide de sémiologie cartographique</a> de l’Insee. Celles-ci sont reprises dans <a href="https://juliedjidji.github.io/memocarto/semio.html">ce guide</a>.</p>
<p><a href="https://neocarto.github.io/docs/slides/ENTPE/docs/#/title-slide">Cette présentation</a> de Nicolas Lambert présente, à partir de nombreux exemples, quelques principes de la <em>dataviz</em> cartographique.</p>
</div>
</div>
<p>Ce TP vise à initier:</p>
<ul>
<li>Au <em>package</em> <a href="https://riatelab.github.io/mapsf/"><code>mapsf</code></a>, conçu par les géographiques du RIATE (Paris 7), le <em>package</em> de référence pour réaliser des cartes avec <i class="fa-brands fa-r-project" aria-label="r-project"></i> <code>geoplot</code> est construit sur <code>seaborn</code> et constitue ainsi une extension des graphiques de base.</li>
<li>Au package <a href="https://rstudio.github.io/leaflet/"><code>leaflet</code></a> qui est un point d’accès vers la librairie <code>JavaScript</code> <a href="https://leafletjs.com/">leaflet</a> permettant de produire des cartes interactives. Nous approfondirons ultérieurement les cartes réactives avec un chapitre d’ouverture vers <a href="https://observablehq.com"><code>Observable</code></a>.</li>
</ul>
<p>Dans ce chapitre, nous allons utiliser les <em>packages</em> suivants:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cartiflette)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="données" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="données"><span class="header-section-number">1</span> Données</h2>
<p>Au cours de ce chapitre, nous allons utiliser principalement trois jeux de données :</p>
<ul>
<li>Les comptages de passage de vélos dans les stations de mesure parisiennnes ;</li>
<li><a href="https://parisdata.opendatasoft.com/explore/dataset/comptage-velo-compteurs/download/?format=geojson&amp;timezone=Europe/Berlin&amp;lang=fr">La localisation précise des stations</a></li>
<li>Les limites officielles administratives des arrondissements et communes de l’agglomération parisienne. Ce fonds de carte est produit par l’IGN et sa récupération est facilitée par le <em>package</em> <code>cartiflette</code>.</li>
</ul>
<section id="comptages" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="comptages"><span class="header-section-number">1.1</span> Comptages</h3>
<p>Un sous-ensemble des données de <a href="https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/information/?disjunctive.id_compteur&amp;disjunctive.nom_compteur&amp;disjunctive.id&amp;disjunctive.name">Paris <em>Open Data</em></a> a été mis à disposition pour faciliter l’import.</p>
<p>Il s’agit d’une extraction, qui commence à dater, des données disponibles sur le site où seules les colonnes qui servent à cet exercice ont été conservées.</p>
<p>Nous proposons de télécharger ces données et les enregistrer dans un fichier sur le disque dur local avant de l’importer<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Cependant, nous n’allons pas faire cela manuellement mais nous allons plutôt utiliser <i class="fa-brands fa-r-project" aria-label="r-project"></i>. Effectuer ce type d’action de manière manuelle serait une mauvaise pratique du point de vue de la reproductibilité.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://minio.lab.sspcloud.fr/projet-formation/diffusion/python-datascientist/bike.csv"</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1">1</button><span id="annotated-cell-3-2" class="code-annotation-target"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(url, <span class="st">"bike.gz"</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2">2</button><span id="annotated-cell-3-3" class="code-annotation-target"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a>comptages <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"bike.gz"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="2" data-code-annotation="1" data-code-cell="annotated-cell-3">L’extension <code>.gz</code> est importante pour la suite car <code>readr</code> en a besoin pour comprendre que le fichier est compressé.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="3" data-code-annotation="2" data-code-cell="annotated-cell-3">Lecture des données avec <code>read_csv</code> du package <code>readr</code></span>
</dd>
</dl>
</div>
</div>
</section>
<section id="localisation-des-compteurs" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="localisation-des-compteurs"><span class="header-section-number">1.2</span> Localisation des compteurs</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>compteurs <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"https://parisdata.opendatasoft.com/api/explore/v2.1/catalog/datasets/comptage-velo-compteurs/exports/geojson?lang=fr&amp;timezone=Europe%2FBerlin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Il y a quelques valeurs aberrantes dans ce jeu de données qui doivent être laissées de côté. Elles sont identifiables par le fait que la variable <code>nom_compteurs</code> ne comporte pas les mentions <code>Bike IN</code> ou <code>Bike OUT</code>. Comme c’est un petit peu avancé pour une introduction, nous donnons directement la solution de ce travail de nettoyage:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>compteurs <span class="ot">&lt;-</span> compteurs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(<span class="st">"(Bike IN|Bike OUT)"</span>, nom_compteur))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fonds-de-carte-contextuels" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="fonds-de-carte-contextuels"><span class="header-section-number">1.3</span> Fonds de carte contextuels</h3>
<p>On va utiliser à nouveau <code>cartiflette</code> pour récupérer les arrondissements parisiens et les communes limitrophes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>arrondissements <span class="ot">&lt;-</span> <span class="fu">download_vectorfile_url_all</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">4326</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">values =</span> <span class="st">"75"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">borders=</span><span class="st">"COMMUNE_ARRONDISSEMENT"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">vectorfile_format=</span><span class="st">"geojson"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">filter_by=</span><span class="st">"DEPARTEMENT"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">source=</span><span class="st">"EXPRESS-COG-CARTO-TERRITOIRE"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">year=</span><span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2154</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="une-première-carte-avec-ggplot" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="une-première-carte-avec-ggplot"><span class="header-section-number">2</span> Une première carte avec <code>ggplot</code></h2>
<p>Lors des chapitres précédents nous avons appris la manière dont des graphiques peuvent être construits en accumulant des couches.</p>
<p>Il est possible d’ajouter des couches sur une image, à condition que les coordonnées coïncident. Pour faire cela de manière fiable, nous allons utiliser le package <code>ggmap</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<p>L’objectif du prochain exercice est de construire la carte suivante, de manière progressive:</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>ℹ Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under CC BY SA.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Coordinate system already present. Adding new coordinate system, which will
replace the existing one.</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="cartography_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice 1: construire la carte des compteurs avec <code>ggmap</code> et <code>ggplot</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour récupérer la carte, nous allons avoir besoin de construire un certain nombre d’objets en amont. En premier lieu, il est nécessaire de créer un vecteur stockant les extrêmes de notre carte. Dans le jargon des SIG, cela s’appelle la <strong><em>bounding box</em></strong>. Voici comment faire ceci:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1">1</button><span id="annotated-cell-1-1" class="code-annotation-target"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a>bbox_paris <span class="ot">&lt;-</span> arrondissements <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="fu">st_bbox</span>()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="2">2</button><span id="annotated-cell-1-2" class="code-annotation-target"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a>bbox_paris <span class="ot">&lt;-</span> <span class="fu">setNames</span>(bbox_paris, <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"bottom"</span>, <span class="st">"right"</span>, <span class="st">"top"</span>))</span>
<span id="annotated-cell-1-3"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a>bbox_paris</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-1">On a besoin de coordonnées en WGS84, il faut donc reprojeter les données avant d’appliquer <code>st_bbox</code></span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-1"><code>ggmap</code> attend un vecteur dont les noms sont <code>"left", "bottom", "right", "top"</code>, <code>setNames</code> permet de renommer les éléments de <code>bbox_paris</code></span>
</dd>
</dl>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>bbox_paris</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     left    bottom     right       top 
 2.224217 48.815562  2.469851 48.902148 </code></pre>
</div>
</div>
<ol type="1">
<li><p>Utiliser <code>get_map</code> pour récupérer le fonds de carte. Nommer l’objet <code>map_paris_watercolor</code>. La carte proposée utilise le fonds <code>watercolor</code>, dont la source est <code>stamen</code>. Utiliser ensuite <code>ggmap(fonds_stamen)</code> pour vérifier le fonds de carte récupéré.</p></li>
<li><p>Ajouter une couche d’arrondissements à cette image avec <code>geom_sf</code>. Il va être nécessaire d’utiliser les arguments suivants:</p></li>
</ol>
<ul>
<li><code>data</code>: comme nous initialisons la figure avec <code>ggmap</code>, il faut dire à <code>ggplot</code> que nous partons du jeu de données <code>arrondissements</code> pour cette couche</li>
<li><code>fill</code> et <code>color</code> pour contrôler, respectivement, la couleur de l’intérieur et des bordures des polygones.</li>
<li><code>inherit.aes = FALSE</code>: indispensable à cause du comportement de <code>ggmap</code> qui ne sait pas gérer les objets <code>sf</code> (cf.&nbsp;<em>footnote</em> antérieure)</li>
</ul>
<ol start="3" type="1">
<li>Ajouter une couche pour représenter la position des stations avec <code>geom_sf</code>. Il va être nécessaire d’utiliser les arguments suivants:</li>
</ol>
<ul>
<li><code>data</code>: comme nous initialisons la figure avec <code>ggmap</code>, il faut dire à <code>ggplot</code> que nous partons du jeu de données <code>compteurs</code> pour cette couche</li>
<li><code>color="red"</code>, <code>size=5</code> et <code>alpha=0.4</code> pour contrôler l’apparence de nos points</li>
<li><code>inherit.aes = FALSE</code>: indispensable à cause du comportement de <code>ggmap</code> qui ne sait pas gérer les objets <code>sf</code> (cf.&nbsp;<em>footnote</em> antérieure)</li>
</ul>
<ol start="4" type="1">
<li>Finaliser l’esthétique de la carte avec <code>theme_void()</code></li>
</ol>
<details>
<summary>
Aide pour la question 1
</summary>
Les arguments à utiliser sont <code>location</code>, <code>maptype</code> et <code>source</code>
</details>
</div>
</div>
<details>
<summary>
Le fonds de carte, sans motif par dessus, est le suivant:
</summary>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>ℹ Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under CC BY SA.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="cartography_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</details>
<details>
<summary>
En ajoutant les arrondissements par dessus (question 2):
</summary>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Coordinate system already present. Adding new coordinate system, which will
replace the existing one.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="cartography_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</details>
<details>
<summary>
Après avoir ajouté les points (question 3)
</summary>
<div class="cell">
<div class="cell-output-display">
<p><img src="cartography_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</details>
<details>
<summary>
Si vous préférez un autre fonds de carte que <code>Watercolor</code>, par exemple <code>Stamen Toner</code>:
</summary>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>ℹ Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Coordinate system already present. Adding new coordinate system, which will
replace the existing one.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="cartography_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</details>
</section>
<section id="heatmap" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="heatmap"><span class="header-section-number">3</span> Heatmap</h2>
</section>
<section id="carte-de-fréquentation-des-stations" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="carte-de-fréquentation-des-stations"><span class="header-section-number">4</span> Carte de fréquentation des stations</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'lubridate'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    date, intersect, setdiff, union</code></pre>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>D’habitude, nous recommandons d’utiliser directement l’URL de téléchargement ce qui évite de créer un fichier intermédiaire sur le disque dur. Néanmoins, ici, l’import direct avec <code>readr</code> ne fonctionnera pas car le fichier est mal interprété par la librairie. Celle-ci ne comprend pas que le fichier est compressé car il lui manque l’extension <code>.gz</code> (un format compressé) à la fin.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><code>ggmap</code> est un <em>package</em> assez ancien qui n’a pas trop évolué récemment. Il continue notamment à utiliser des objets <code>sp</code>, l’ancêtre de <code>sf</code> qui existe déjà depuis plusieurs années. Il est donc possible que ce <em>package</em> soit archivé dans un futur plus ou moins lointain.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Handle positioning of the toggle
      window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>