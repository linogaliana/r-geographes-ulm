<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lino Galiana">

<title>Introduction aux méthodes quantitatives avec  - Importer et manipuler des données avec </title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="Introduction aux méthodes quantitatives avec  - Importer et manipuler des données avec ">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://rgeo.linogaliana.fr/cards/version-light/baby.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Introduction aux méthodes quantitatives avec <i class="fa-brands fa-r-project" aria-label="r-project"></i></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../exercises/r-base.html" rel="" target="">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../exercises/r-wrangling.html" rel="" target="" aria-current="page">
 <span class="menu-text">Manipulation</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/linogaliana/r-geographie" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#etapes-préliminaires-installer-les-packages" id="toc-etapes-préliminaires-installer-les-packages" class="nav-link active" data-scroll-target="#etapes-préliminaires-installer-les-packages"><span class="header-section-number">1</span> Etapes préliminaires: installer les <em>packages</em></a></li>
  <li><a href="#importer-les-données" id="toc-importer-les-données" class="nav-link" data-scroll-target="#importer-les-données"><span class="header-section-number">2</span> Importer les données</a>
  <ul class="collapse">
  <li><a href="#import-dun-csv-de-lademe" id="toc-import-dun-csv-de-lademe" class="nav-link" data-scroll-target="#import-dun-csv-de-lademe"><span class="header-section-number">2.1</span> Import d’un csv de l’Ademe</a></li>
  <li><a href="#import-de-données-de-linsee" id="toc-import-de-données-de-linsee" class="nav-link" data-scroll-target="#import-de-données-de-linsee"><span class="header-section-number">2.2</span> Import de données de l’Insee</a></li>
  </ul></li>
  <li><a href="#nettoyage-des-données" id="toc-nettoyage-des-données" class="nav-link" data-scroll-target="#nettoyage-des-données"><span class="header-section-number">3</span> Nettoyage des données</a></li>
  <li><a href="#restructurer-des-données" id="toc-restructurer-des-données" class="nav-link" data-scroll-target="#restructurer-des-données"><span class="header-section-number">4</span> Restructurer des données</a></li>
  <li><a href="#combiner-les-données" id="toc-combiner-les-données" class="nav-link" data-scroll-target="#combiner-les-données"><span class="header-section-number">5</span> Combiner les données</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Importer et manipuler des données avec <i class="fa-brands fa-r-project" aria-label="r-project"></i></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lino Galiana </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="badge">
<p><a href="https://datalab.sspcloud.fr/launcher/ide/rstudio?autoLaunch=true&amp;init.personalInit=«https%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fr-geographie%2Fmain%2Fsspcloud%2Finit.sh»&amp;networking.user.enabled=true&amp;onyxia.friendlyName=«rstudio-cours-ENS»" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/Tester%20via%20SSP%20cloud%20-%20SSPCloud?logo=R&amp;labelColor=black&amp;color=%231965b8" alt="Onyxia"></a><br></p>
</div>
<details>
<summary>
Dérouler les <em>slides</em> ci-dessous ou <a href="../slides/wrangling.html">cliquer ici</a> pour afficher les slides en plein écran.
</summary>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><iframe class="sourceCode yaml code-with-copy" src="/slides/wrangling.html"></iframe></div>
</details>
<p>Dans ce deuxième TP, nous allons apprendre à importer et manipuler des données avec <i class="fa-brands fa-r-project" aria-label="r-project"></i>.</p>
<p>Si vous êtes intéressés par <code>Python</code> <i class="fa-brands fa-python" aria-label="python"></i>, une version très proche de ce TP est disponible dans <a href="https://pythonds.linogaliana.fr/content/manipulation/02b_pandas_TP.html">mon cours de l’ENSAE</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Certains exemples de code présentent des annotations sur le côté, passez votre souris dessus pour les afficher, comme ci-dessous</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1">1</button><span id="annotated-cell-1-1" class="code-annotation-target"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="st">"une annotation explicative m'accompagne à droite"</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-annotation="1" data-code-cell="annotated-cell-1" data-code-lines="1">Je m’affiche quand on passe la souris sur moi 🐭 !</span>
</dd>
</dl>
</div>
</div>
</div>
</div>
<p>Dans ce chapitre, nous allons principalement utiliser les packages suivants du <code>tidyverse</code>:</p>
<ul>
<li><code>readr</code> pour l’import de données ;</li>
<li><code>dplyr</code> pour la manipulation de données.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le <code>tidyverse</code> n’est pas le seul écosystème complet pour analyser des données.</p>
<p>Néanmoins, pour une introduction à <i class="fa-brands fa-r-project" aria-label="r-project"></i>, c’est certainement le plus raisonnable à adopter.</p>
<p>Les écosystèmes concurrents ou complémentaires (<code>data.table</code>, <code>arrow</code>, <code>duckdb</code>) nécessitent déjà une bonne compréhension du <code>tidyverse</code> et de ses limites.</p>
</div>
</div>
<p>Dans ce tutoriel, nous allons utiliser deux sources de données :</p>
<ul>
<li>Les émissions de gaz à effet de serre estimées au niveau communal par l’<code>ADEME</code>. Le jeu de données est disponible sur <a href="https://www.data.gouv.fr/fr/datasets/inventaire-de-gaz-a-effet-de-serre-territorialise/#_">data.gouv</a> et requêtable directement dans <i class="fa-brands fa-r-project" aria-label="r-project"></i> avec <a href="https://koumoul.com/s/data-fair/api/v1/datasets/igt-pouvoir-de-rechauffement-global/convert">cet url</a> (ce sera l’objet du premier exercice)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</li>
<li>Idéalement, on utiliserait directement les données <a href="https://www.insee.fr/fr/statistiques/3560121">disponibles sur le site de l’Insee</a> mais celles-ci nécessitent un peu de travail de nettoyage qui n’entre pas dans le cadre de ce TP. Pour faciliter l’import de données Insee, il est recommandé d’utiliser les <em>packages</em> <a href="https://github.com/InseeFrLab/DoReMIFaSol"><code>doremifasol</code></a> et <a href="https://github.com/pyr-opendatafr/R-Insee-Data"><code>insee</code></a> qui simplifient l’accès aux données de l’Insee disponibles sur le site web <a href="https://www.insee.fr/fr/accueil">insee.fr</a> ou via des API.</li>
</ul>
<section id="etapes-préliminaires-installer-les-packages" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Etapes préliminaires: installer les <em>packages</em></h1>
<p><i class="fa-brands fa-r-project" aria-label="r-project"></i> est un langage <em>open source</em>. N’importe qui peut donc proposer du code <i class="fa-brands fa-r-project" aria-label="r-project"></i> pour accroître les fonctionnalités du langage. Un ensemble cohérent de fonctionnalités s’appelle une <strong>librairie</strong> ou un <strong>package</strong>.</p>
<p>Comme l’équipe qui gère le langage <i class="fa-brands fa-r-project" aria-label="r-project"></i> n’a pas vocation à intégrer toutes les librairies dans le langage de base (celui-ci se doit de rester, comme son nom l’indique, basique), il existe des espaces communautaires où les gens peuvent mettre à disposition leurs <em>packages</em>. Dans l’écosystème <i class="fa-brands fa-r-project" aria-label="r-project"></i>, les deux principaux<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> sont:</p>
<ul>
<li>Le <code>CRAN</code> (<em>Comprehensive R Archive Network</em>): le dépôt officiel et historique de librairies <i class="fa-brands fa-r-project" aria-label="r-project"></i>. Pour installer un <em>package</em> stocké dans cet espace, on utilise <code>install.package</code> ;</li>
<li><code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i>: le réseau social du code <em>open source</em>. Pour installer un <em>package</em> stocké dans cet espace, on utilise <code>remotes::install_github</code><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>En général, les <em>packages</em> avec une certaine maturité sont sur le CRAN. <code>Github</code> a un aspect plus fourre-tout où on trouve des mines d’or à côté de choses de qualité plus variable.</p>
<p>Certains <em>packages</em> que nous verrons ne sont pas sur le CRAN car la procédure de validation pour pouvoir y déposer son <em>package</em> est assez lourde et fatiguante pour des développeurs bénévoles, généralement non rémunéré pour ce travail et qui effectuent souvent cela la nuit.</p>
</div>
</div>
<p>Nous allons supposer que les principales librairies du <code>tidyverse</code> sont déjà installées. Sinon, vous pouvez les installer en suivant la documentation en ligne.</p>
<p>Pour installer un package disponible sur le CRAN, par exemple le package <a href="https://cran.r-project.org/web/packages/insee/index.html"><code>insee</code></a>, vous pouvez faire:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"insee"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pour installer un package disponible sur <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i>, par exemple <a href="https://github.com/InseeFrLab/DoReMIFaSol"><code>doremifasol</code></a> qui est disponible sur le dépôt du compte <code>InseeFrLab</code>, on fait:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">'inseefrlab/DoReMIFaSol'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="importer-les-données" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Importer les données</h1>
<section id="import-dun-csv-de-lademe" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="import-dun-csv-de-lademe"><span class="header-section-number">2.1</span> Import d’un csv de l’Ademe</h2>
<p>Pour commencer, nous allons importer les données de l’Ademe à l’aide du <em>package</em> <a href="https://readr.tidyverse.org/"><code>readr</code></a>[^readcsv].</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice 1: lire un csv avec <code>readr</code> et observer les données
</div>
</div>
<div class="callout-body-container callout-body">
<p>Voici l’URL sur lequel les données sont disponibles</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://koumoul.com/s/data-fair/api/v1/datasets/igt-pouvoir-de-rechauffement-global/convert"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>Utiliser le <em>package</em> <code>readr</code> pour importer ces données. Nommer cet objet <code>emissions</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></li>
<li>Afficher les premières lignes avec <code>head</code> et observer la différence d’affichage avec, par exemple, ce <code>dataframe</code>:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>emissions <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 35798 Columns: 12
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): INSEE commune, Commune
dbl (10): Agriculture, Autres transports, Autres transports international, C...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"com"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"val"</span> <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">2</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  com        val
1   1  0.5667052
2   2 -0.4524874</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Afficher la classe de <code>emissions</code>. Comprenez-vous maintenant pourquoi cet objet est un peu différent d’un dataframe de base ?</li>
<li>Utiliser les fonctions adéquates pour les 10 premières valeurs, les 15 dernières et un échantillon aléatoire de 10 valeurs grâce à la <a href="https://dplyr.tidyverse.org/reference/sample_n.html">fonction adéquate du package <code>dplyr</code></a></li>
</ol>
<details>
<summary>
En cas de blocage à la question 1
</summary>
Lire la documentation de <code>read_csv</code> (très bien faite) ou chercher des exemples en ligne pour découvrir cette fonction. ⚠️ Ne pas utiliser <code>read.csv</code> (fonction de base) qui n’est pas performante.
</details>
</div>
</div>
</section>
<section id="import-de-données-de-linsee" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="import-de-données-de-linsee"><span class="header-section-number">2.2</span> Import de données de l’Insee</h2>
<p>En ce qui concerne nos informations communales, on va utiliser l’une des plus sources de l’Insee les plus utilisées : les données <a href="https://www.insee.fr/fr/metadonnees/source/serie/s1172"><code>Filosofi</code></a>. Afin de faciliter la récupération de celles-ci, nous allons utiliser le <em>package</em> communautaire <code>doremifasol</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doremifasol)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>filosofi <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">telechargerDonnees</span>(<span class="st">"FILOSOFI_COM"</span>, <span class="at">date =</span> <span class="dv">2016</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(filosofi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 29
  CODGEO LIBGEO      NBMENFISC16 NBPERSMENFISC16  MED16 PIMP16 TP6016 TP60AGE116
  &lt;chr&gt;  &lt;chr&gt;             &lt;dbl&gt;           &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;
1 01001  L'Abergeme…         313            796. 22679      NA     NA         NA
2 01002  L'Abergeme…         101            248  24382.     NA     NA         NA
3 01004  Ambérieu-e…        6363          14228  19721      49     17         19
4 01005  Ambérieux-…         633           1662. 23378      NA     NA         NA
5 01006  Ambléon              NA             NA     NA      NA     NA         NA
6 01007  Ambronay           1087           2684  22146.     57     NA         NA
# ℹ 21 more variables: TP60AGE216 &lt;dbl&gt;, TP60AGE316 &lt;dbl&gt;, TP60AGE416 &lt;dbl&gt;,
#   TP60AGE516 &lt;dbl&gt;, TP60AGE616 &lt;dbl&gt;, TP60TOL116 &lt;dbl&gt;, TP60TOL216 &lt;dbl&gt;,
#   PACT16 &lt;dbl&gt;, PTSA16 &lt;dbl&gt;, PCHO16 &lt;dbl&gt;, PBEN16 &lt;dbl&gt;, PPEN16 &lt;dbl&gt;,
#   PPAT16 &lt;dbl&gt;, PPSOC16 &lt;dbl&gt;, PPFAM16 &lt;dbl&gt;, PPMINI16 &lt;dbl&gt;, PPLOGT16 &lt;dbl&gt;,
#   PIMPOT16 &lt;dbl&gt;, D116 &lt;dbl&gt;, D916 &lt;dbl&gt;, RD16 &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>La fonction <code>as_tibble</code> nous sert à transformer le <em>dataframe</em> de base (<code>doremifasol</code> ne fait pas d’<em>a priori</em> sur l’écosystème de manipulation adopté) en <em>dataframe</em> adapté à une exploitation via le <code>tidyverse</code>.</p>
</div>
</div>
</section>
</section>
<section id="nettoyage-des-données" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Nettoyage des données</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice 2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Comme c’est <code>readr</code> ou <code>doremifasol</code> qui ont géré automatiquement l’import des données, on va faire un petit contrôle qualité:</p>
<ol type="1">
<li>Afficher le nom des colonnes de nos <em>dataframes</em> <code>emissions</code> et <code>filosofi</code>. Quelles sont les colonnes communes ? Utiliser la fonction <code>intersect</code> et comprendre la nature du problème.</li>
<li>Observer la structure de nos jeux de données (les types des colonnes). Les types fixés par défaut sont-ils adéquats ?</li>
</ol>
<p>Ensuite, on vérifie les dimensions des <code>DataFrames</code> et la structure de certaines variables clés. En l’occurrence, les variables fondamentales pour lier nos données sont les variables communales. Ici, on a deux variables géographiques: un code commune et un nom de commune. On va donc vérifier qu’elles sont bien adaptées à l’analyse statistique.</p>
<ol start="3" type="1">
<li>Vérifier les dimensions des <em>dataframes</em> ;</li>
<li>Vérifier le nombre de valeurs uniques des variables géographiques dans chaque base. Les résultats apparaissent-ils cohérents ?</li>
<li>Identifier dans <code>filosofi</code> les noms de communes qui correspondent à plusieurs codes communes et sélectionner leurs codes. En d’autres termes, identifier les <code>CODGEO</code> tels qu’il existe des doublons de <code>LIBGEO</code> et les stocker dans un dataframe <code>duplicates</code></li>
</ol>
<p>On se focalise temporairement sur les observations où le libellé comporte plus de deux codes communes différents</p>
<ol start="6" type="1">
<li>Regarder dans <code>filosofi</code> ces observations. Pour mieux y voir, réordonner la base obtenue par order alphabétique</li>
<li>Déterminer la taille moyenne (variable nombre de personnes: <code>NBPERSMENFISC16</code>) et quelques statistiques descriptives de ces données. Comparer aux mêmes statistiques sur les données où libellés et codes communes coïncident</li>
<li>Vérifier les grandes villes (plus de 100 000 personnes), la proportion de villes pour lesquelles un même nom est associé à différents codes commune.</li>
<li>Vérifier dans <code>filosofi</code> les villes dont le libellé est égal à Montreuil. Vérifier également celles qui contiennent le terme ‘Saint-Denis’</li>
</ol>
<details>
<summary>
Ce que vous devriez trouver dans les questions 8 et 9
</summary>
<p>Pour la question 8, vous devriez obtenir ceci:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 30
  CODGEO LIBGEO      NBMENFISC16 NBPERSMENFISC16  MED16 PIMP16 TP6016 TP60AGE116
  &lt;chr&gt;  &lt;chr&gt;             &lt;dbl&gt;           &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;
1 93048  Montreuil         43996         108682  18428      55     26         29
2 93066  Saint-Denis       39469         108346. 14622.     39     38         35
3 97411  Saint-Denis       57567         145396. 16317.     35     34         47
4 97415  Saint-Paul        37064         105829  16279.     35     33         42
# ℹ 22 more variables: TP60AGE216 &lt;dbl&gt;, TP60AGE316 &lt;dbl&gt;, TP60AGE416 &lt;dbl&gt;,
#   TP60AGE516 &lt;dbl&gt;, TP60AGE616 &lt;dbl&gt;, TP60TOL116 &lt;dbl&gt;, TP60TOL216 &lt;dbl&gt;,
#   PACT16 &lt;dbl&gt;, PTSA16 &lt;dbl&gt;, PCHO16 &lt;dbl&gt;, PBEN16 &lt;dbl&gt;, PPEN16 &lt;dbl&gt;,
#   PPAT16 &lt;dbl&gt;, PPSOC16 &lt;dbl&gt;, PPFAM16 &lt;dbl&gt;, PPMINI16 &lt;dbl&gt;, PPLOGT16 &lt;dbl&gt;,
#   PIMPOT16 &lt;dbl&gt;, D116 &lt;dbl&gt;, D916 &lt;dbl&gt;, RD16 &lt;dbl&gt;, probleme &lt;lgl&gt;</code></pre>
</div>
</div>
<p>Alors que pour la question 9, vos deux <em>dataframes</em> ressembleront à</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 29
  CODGEO LIBGEO    NBMENFISC16 NBPERSMENFISC16  MED16 PIMP16 TP6016 TP60AGE116
  &lt;chr&gt;  &lt;chr&gt;           &lt;dbl&gt;           &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;
1 28267  Montreuil         215            503  24823.     NA     NA         NA
2 62588  Montreuil         994           1951  18762      NA     NA         NA
3 85148  Montreuil         340            884. 19340      NA     NA         NA
4 93048  Montreuil       43996         108682  18428      55     26         29
# ℹ 21 more variables: TP60AGE216 &lt;dbl&gt;, TP60AGE316 &lt;dbl&gt;, TP60AGE416 &lt;dbl&gt;,
#   TP60AGE516 &lt;dbl&gt;, TP60AGE616 &lt;dbl&gt;, TP60TOL116 &lt;dbl&gt;, TP60TOL216 &lt;dbl&gt;,
#   PACT16 &lt;dbl&gt;, PTSA16 &lt;dbl&gt;, PCHO16 &lt;dbl&gt;, PBEN16 &lt;dbl&gt;, PPEN16 &lt;dbl&gt;,
#   PPAT16 &lt;dbl&gt;, PPSOC16 &lt;dbl&gt;, PPFAM16 &lt;dbl&gt;, PPMINI16 &lt;dbl&gt;, PPLOGT16 &lt;dbl&gt;,
#   PIMPOT16 &lt;dbl&gt;, D116 &lt;dbl&gt;, D916 &lt;dbl&gt;, RD16 &lt;dbl&gt;</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 29
   CODGEO LIBGEO     NBMENFISC16 NBPERSMENFISC16  MED16 PIMP16 TP6016 TP60AGE116
   &lt;chr&gt;  &lt;chr&gt;            &lt;dbl&gt;           &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;
 1 01344  Saint-Den…        2562           6036  23258      63      7         NA
 2 01345  Saint-Den…         965           2280  21464      53     NA         NA
 3 02818  Villiers-…         365            901  22221      NA     NA         NA
 4 11339  Saint-Den…         224            474. 18477.     NA     NA         NA
 5 14571  Saint-Den…         124            298. 20860.     NA     NA         NA
 6 14572  Saint-Den…         331            770. 20080      NA     NA         NA
 7 17323  Saint-Den…         733           1401  21364.     NA     NA         NA
 8 18204  Saint-Den…         125            314. 21446.     NA     NA         NA
 9 21442  Morey-Sai…         285            664. 25946.     NA     NA         NA
10 25129  Chassagne…          50            116  21357.     NA     NA         NA
# ℹ 21 more variables: TP60AGE216 &lt;dbl&gt;, TP60AGE316 &lt;dbl&gt;, TP60AGE416 &lt;dbl&gt;,
#   TP60AGE516 &lt;dbl&gt;, TP60AGE616 &lt;dbl&gt;, TP60TOL116 &lt;dbl&gt;, TP60TOL216 &lt;dbl&gt;,
#   PACT16 &lt;dbl&gt;, PTSA16 &lt;dbl&gt;, PCHO16 &lt;dbl&gt;, PBEN16 &lt;dbl&gt;, PPEN16 &lt;dbl&gt;,
#   PPAT16 &lt;dbl&gt;, PPSOC16 &lt;dbl&gt;, PPFAM16 &lt;dbl&gt;, PPMINI16 &lt;dbl&gt;, PPLOGT16 &lt;dbl&gt;,
#   PIMPOT16 &lt;dbl&gt;, D116 &lt;dbl&gt;, D916 &lt;dbl&gt;, RD16 &lt;dbl&gt;</code></pre>
</div>
</div>
</details>
</div>
</div>
<p>Ce petit exercice permet de se rassurer car les libellés dupliqués sont en fait des noms de commune identiques mais qui ne sont pas dans le même département. Il ne s’agit donc pas d’observations dupliquées. On se fiera ainsi aux codes communes, qui eux sont uniques.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice 3
</div>
</div>
<div class="callout-body-container callout-body">
<p>On va commencer l’exploration de données. Cela implique un peu de nettoyage de données en amont.</p>
<ol type="1">
<li>Renommer la variable <code>INSEE commune</code> en <code>code_insee</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</li>
<li>Les deux premiers chiffres des codes communes sont le numéro de département. Créer une variable de département <code>dep</code> dans <code>emissions</code> et dans <code>filosofi</code> en utilisant la fonction <code>str_sub</code> du package <code>stringr</code><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</li>
</ol>
<p>Commençons le calcul de nos premières statistiques descriptives.</p>
<ol start="3" type="1">
<li><p>Calculer les émissions totales par secteur pour chaque département. Mettre en <em>log</em> ces résultats dans un objet <code>emissions_log</code>. La <a href="#fig-sample-log">Figure&nbsp;1</a> illustre la structure de ces émissions sur 5 départements aléatoires.</p></li>
<li><p>Repartir du jeu de données <code>emissions</code>. Calculer les émissions totales par département et sortir la liste des 10 principaux émetteurs de CO2 et des 5 départements les moins émetteurs. Sans faire de <em>merge</em>, regarder les caractéristiques de ces départements (population et niveau de vie)</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>emissions_log_sample <span class="ot">&lt;-</span> emissions_log <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dep <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="fu">unique</span>(dep),<span class="dv">5</span>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>emissions_log_sample <span class="ot">&lt;-</span> emissions_log_sample <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>dep, <span class="at">names_to =</span> <span class="st">"Category"</span>, <span class="at">values_to =</span> <span class="st">"Value"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(emissions_log_sample, <span class="fu">aes</span>(<span class="at">x =</span> dep, <span class="at">y =</span> Value, <span class="at">fill =</span> Category)) <span class="sc">+</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Department"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">scale_fill_viridis_d</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 rows containing missing values (`geom_bar()`).</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-sample-log" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="r-wrangling_files/figure-html/fig-sample-log-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Structure des émissions de cinq départements aléatoires</figcaption>
</figure>
</div>
</div>
</div>
<details>
<summary>
Exemple d’utilisation de <code>str_sub</code>
</summary>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">str_sub</span>(y, <span class="at">start =</span> <span class="dv">3</span>, <span class="at">end =</span> <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
<section id="restructurer-des-données" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Restructurer des données</h1>
<p>On présente généralement deux types de données :</p>
<ul>
<li>format <strong>wide</strong>: les données comportent des observations répétées, pour un même individu (ou groupe), dans des colonnes différentes</li>
<li>format <strong>long</strong>: les données comportent des observations répétées, pour un même individu, dans des lignes différentes avec une colonne permettant de distinguer les niveaux d’observations</li>
</ul>
<p>Un exemple de la distinction entre les deux peut être pris à l’ouvrage de référence d’Hadley Wickham, <em>R for Data Science</em>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://d33wubrfki0l68.cloudfront.net/3aea19108d39606bbe49981acda07696c0c7fcd8/2de65/images/tidy-9.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Données <em>long</em> (gauche) et <em>wide</em> (droite) (source: <em>R for Data Science</em>)</figcaption>
</figure>
</div>
<p>On est souvent amené avec <i class="fa-brands fa-r-project" aria-label="r-project"></i> à restructurer les données pour les allonger (<em>wide to long</em>) et les élargir (<em>long to wide</em>).</p>
<p>C’est le package <em>tidyr</em> (qui appartient au <em>tidyverse</em>) qui permet de faire ce type de transformations.</p>
<p>L’aide mémoire suivante aidera à se rappeler les fonctions à appliquer si besoin:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://scienceparkstudygroup.github.io/r-lesson-based-on-ohi-data-training/img/rstudio-cheatsheet-spread-gather-sep-unite.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Le fait de passer d’un format <em>wide</em> au format <em>long</em> (ou vice-versa) peut être extrêmement pratique car certaines fonctions sont plus adéquates sur une forme de données ou sur l’autre.</p>
<p>En règle générale, les formats <em>long</em> sont souvent préférables car il est plus facile d’itérer sur des lignes que sur des colonnes du fait de la nature vectorielle de <i class="fa-brands fa-r-project" aria-label="r-project"></i>. C’est notamment la forme de données privilégiée pour préparer des graphiques avec <code>ggplot</code>, que nous découvrirons dans le prochain chapitre.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice 4: la transformation <em>wide to long</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Restructurer les données au format <em>long</em> pour avoir des données d’émissions par secteur en gardant comme niveau d’analyse la commune (attention aux autres variables identifiantes).</li>
<li>Faire la somme par secteur et représenter graphiquement un <em>barplot</em><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></li>
<li>Garder, pour chaque département, le secteur le plus polluant</li>
</ol>
<details>
<summary>
Graphique à réaliser pour la question 2
</summary>
<p>Une fois le <em>dataframe</em> <code>df_long_summary</code> créé, le code minimal pour réaliser le <em>barplot</em> voulu est:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_long_summary) <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> secteur, <span class="at">x =</span> emissions),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span><span class="st">'identity'</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="r-wrangling_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Pas besoin d’aller plus loin pour le moment, nous ferons plus de <code>ggplot</code> ultérieurement.</p>
</details>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'secteur'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
# Groups:   dep [6]
  secteur     dep   emissions
  &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;
1 Routier     01     1635350.
2 Routier     02     1386403.
3 Agriculture 03     1949985.
4 Routier     04      390568.
5 Routier     05      345859.
6 Routier     06     1561664.</code></pre>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice 5: <em>long to wide</em>
</div>
</div>
<div class="callout-body-container callout-body">
<p>TO DO</p>
</div>
</div>
</section>
<section id="combiner-les-données" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Combiner les données</h1>
<p>Une information que l’on cherche à obtenir s’obtient de moins en moins à partir d’une unique base de données. Il devient commun de devoir combiner des données issues de sources différentes.</p>
<p>Nous allons ici nous focaliser sur le cas le plus favorable qui est la situation où une information permet d’apparier de manière exacte deux bases de données (autrement nous serions dans une situation, beaucoup plus complexe, d’appariement flou). La situation typique est l’appariement entre deux sources de données selon un identifiant individuel ou un identifiant de code commune, ce qui est notre cas.</p>
<p>Il est recommandé de lire <a href="https://www.book.utilitr.org/03_fiches_thematiques/fiche_joindre_donnees">ce guide assez complet sur la question des jointures avec <i class="fa-brands fa-r-project" aria-label="r-project"></i></a> qui donne des recommandations également utiles en <code>Python</code> <i class="fa-brands fa-python" aria-label="python"></i>.</p>
<p>Dans le langage courant du statisticien, on utilise de manière indifférente les termes <em>merge</em> ou <em>join</em>. Le deuxième terme provient de la syntaxe <code>SQL</code> et c’est celui qui est plutôt utilisé quand on code avec <code>dplyr</code>.</p>
<details>
<summary>
Les différents type de <em>join</em> disponibles dans <code>dplyr</code>
</summary>
<p><img src="https://rafalab.dfci.harvard.edu/dsbook/wrangling/img/joins.png" class="img-fluid" style="width:80.0%"></p>
</details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice 6: enrichir les données d’émissions
</div>
</div>
<div class="callout-body-container callout-body">
<ol start="2" type="1">
<li>Faire une jointure à gauche entre les données d’émissions et les données de cadrage. Comparer les émissions moyennes des villes sans <em>match</em> (celles dont des variables bien choisies de la table de droite sont <code>NA</code>) avec celles où on a bien une valeur correspondante dans la base Insee</li>
<li>Faire un <em>inner join</em> puis calculer l’empreinte carbone (l’émission rapportée au nombre de ménages fiscaux) dans chaque commune. Sortir un histogramme en niveau puis en log et quelques statistiques descriptives sur le sujet.</li>
<li>Regarder la corrélation entre les variables de cadrage et l’empreinte carbone. Certaines variables semblent-elles pouvoir potentiellement influer sur l’empreinte carbone ?</li>
</ol>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4454 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="r-wrangling_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="r-wrangling_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><code>readr</code> offre la possibilité d’importer des données directement depuis un url. C’est l’option prise dans ce tutoriel. Si vous préfèrez, pour des raisons d’accès au réseau ou de performance, importer depuis un poste local, vous pouvez télécharger les données et changer les commandes d’import avec le chemin adéquat plutôt que l’url.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Il existe également <code>bioconductor</code> mais celui-ci étant surtout orienté biostatistiques (une des communautés académiques ayant adopté <i class="fa-brands fa-r-project" aria-label="r-project"></i> le plus tôt), nous ne l’utilisons pas vraiment<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><code>remotes::install_github</code> signifie d’utiliser la fonction <code>install_github</code> du <em>package</em> <code>remotes</code>. Autrement dit, il faut un <em>package</em> pour installer d’autres <em>packages</em> 🤯. C’est parce que <code>Github</code> n’existait pas lors de la création de <i class="fa-brands fa-r-project" aria-label="r-project"></i> (années 1990) et que cette fonctionnalité n’a pas été ajouté depuis.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Par manque d’imagination, on est souvent tenté d’appeler notre <em>dataframe</em> principal <code>df</code> ou <code>data</code>. C’est souvent une mauvaise idée puisque ce nom n’est pas très informatif quand on relit le code quelques semaines plus tard. L’autodocumentation, approche qui consiste à avoir un code qui se comprend de lui-même, est une bonne pratique et il est donc recommandé de donner un nom simple mais efficace pour connaître la nature du <em>dataset</em> en question.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>L’espace dans le nom de la variable est embêtant. Pour pouvoir utiliser le nom de cet variable dans <code>rename</code>, il va falloir utiliser des backticks, c’est-à-dire <code>INSEE commune</code>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Les fonctionnalités limitées du langage de base sur la manipulation textuelle sont rapidement contraignantes. On passe ainsi rapidement à <code>stringr</code> même si ce n’est pas l’objet principal du chapitre.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>vous pouvez utiliser directement le morceau de code d’aide si vous n’êtes pas familiers de <code>ggplot</code><a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Handle positioning of the toggle
      window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>